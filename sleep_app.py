#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç¡å‰å†…å®¹ç”Ÿæˆå™¨ - Streamlit Webåº”ç”¨
åŠŸèƒ½ï¼šç¡å‰æ•…äº‹ç”Ÿæˆ + å†¥æƒ³å¼•å¯¼è„šæœ¬ + ç¡çœ æ—¥è®°æ¨¡æ¿
"""

import streamlit as st
import dashscope
from dashscope import Generation

# ===== é…ç½®åŒºåŸŸ =====
# è¯·æŠŠä¸‹é¢çš„ 'your-api-key-here' æ›¿æ¢æˆä½ è‡ªå·±çš„API Key
API_KEY = 'your-api-key-here' 

# è®¾ç½®API Key
dashscope.api_key = API_KEY

# ===== é¡µé¢é…ç½® =====
st.set_page_config(
    page_title="ç¡å‰å†…å®¹ç”Ÿæˆå™¨",
    page_icon="ğŸŒ™",
    layout="wide"
)

# ===== è¾…åŠ©å‡½æ•° =====

def call_ai(prompt, temperature=0.8):
    """
    è°ƒç”¨é€šä¹‰åƒé—®APIç”Ÿæˆå†…å®¹
    
    å‚æ•°:
        prompt: æç¤ºè¯
        temperature: æ¸©åº¦å‚æ•°ï¼ˆåˆ›æ„åº¦ï¼‰
    
    è¿”å›:
        ç”Ÿæˆçš„æ–‡æœ¬
    """
    try:
        response = Generation.call(
            model='qwen-turbo',
            messages=[
                {'role': 'system', 'content': 'ä½ æ˜¯ä¸€ä¸ªæ¸©æŸ”ä¸“ä¸šçš„ç¡çœ å†…å®¹åˆ›ä½œè€…ã€‚'},
                {'role': 'user', 'content': prompt}
            ],
            result_format='message',
            temperature=temperature,
        )
        
        if response.status_code == 200:
            return response.output.choices[0].message.content
        else:
            return f"ç”Ÿæˆå¤±è´¥ï¼Œé”™è¯¯ç ï¼š{response.status_code}"
            
    except Exception as e:
        return f"å‘ç”Ÿé”™è¯¯ï¼š{str(e)}"


# ===== é¡µé¢æ ‡é¢˜ =====
st.title("ğŸŒ™ ç¡å‰å†…å®¹ç”Ÿæˆå™¨")
st.markdown("---")
st.write("æ¬¢è¿ä½¿ç”¨ç¡å‰å†…å®¹ç”Ÿæˆå™¨ï¼é€‰æ‹©ä¸‹é¢çš„åŠŸèƒ½ï¼Œå¸®ä½ å‡†å¤‡ä¸€ä¸ªç¾å¥½çš„ç¡çœ å¤œæ™š ğŸ’¤")

# ===== åŠŸèƒ½é€‰æ‹© =====
tab1, tab2, tab3 = st.tabs(["ğŸ“– ç¡å‰æ•…äº‹ç”Ÿæˆ", "ğŸ§˜ å†¥æƒ³å¼•å¯¼è„šæœ¬", "ğŸ“ ç¡çœ æ—¥è®°æ¨¡æ¿"])

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åŠŸèƒ½1ï¼šç¡å‰æ•…äº‹ç”Ÿæˆ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab1:
    st.header("ğŸ“– ç¡å‰æ•…äº‹ç”Ÿæˆ")
    st.write("é€‰æ‹©ä¸€ä¸ªä¸»é¢˜ï¼ŒAIä¼šä¸ºä½ åˆ›ä½œä¸€ä¸ªåŸåˆ›çš„ç¡å‰æ•…äº‹~")
    
    col1, col2 = st.columns(2)
    
    with col1:
        # ä¸»é¢˜é€‰æ‹©
        theme = st.selectbox(
            "é€‰æ‹©æ•…äº‹ä¸»é¢˜",
            ["ğŸŒ² æ£®æ—", "â­ æ˜Ÿç©º", "ğŸŒŠ æµ·æ´‹", "ğŸ”ï¸ å±±è°·", "ğŸŒ¸ èŠ±å›­", "â„ï¸ é›ªåœ°"]
        )
        
        # æ•…äº‹é•¿åº¦
        length = st.select_slider(
            "æ•…äº‹é•¿åº¦",
            options=["çŸ­ï¼ˆ3åˆ†é’Ÿï¼‰", "ä¸­ï¼ˆ5åˆ†é’Ÿï¼‰", "é•¿ï¼ˆ8åˆ†é’Ÿï¼‰"],
            value="ä¸­ï¼ˆ5åˆ†é’Ÿï¼‰"
        )
    
    with col2:
        # æ•…äº‹é£æ ¼
        style = st.radio(
            "æ•…äº‹é£æ ¼",
            ["æ¸©é¦¨æ²»æ„ˆ", "å¥‡å¹»å†’é™©", "å¹³é™èˆ’ç¼“"]
        )
    
    # ç”ŸæˆæŒ‰é’®
    if st.button("âœ¨ ç”Ÿæˆç¡å‰æ•…äº‹", key="story_btn"):
        with st.spinner("æ­£åœ¨åˆ›ä½œæ•…äº‹..."):
            # æ„å»ºæç¤ºè¯
            length_map = {
                "çŸ­ï¼ˆ3åˆ†é’Ÿï¼‰": "300å­—å·¦å³",
                "ä¸­ï¼ˆ5åˆ†é’Ÿï¼‰": "500å­—å·¦å³",
                "é•¿ï¼ˆ8åˆ†é’Ÿï¼‰": "800å­—å·¦å³"
            }
            
            prompt = f"""
è¯·åˆ›ä½œä¸€ä¸ªç¡å‰æ•…äº‹ã€‚

è¦æ±‚ï¼š
- ä¸»é¢˜ï¼š{theme}
- é£æ ¼ï¼š{style}
- é•¿åº¦ï¼š{length_map[length]}
- è¯­è¨€è¦æ¸©æŸ”ã€èˆ’ç¼“ï¼Œé€‚åˆç¡å‰é˜…è¯»
- ç»“å±€è¦å¹³é™ã€ç¾å¥½ï¼Œè®©äººå¿ƒæƒ…æ”¾æ¾
- ä¸è¦æœ‰ç´§å¼ åˆºæ¿€çš„æƒ…èŠ‚

è¯·ç›´æ¥è¾“å‡ºæ•…äº‹å†…å®¹ï¼Œä¸è¦å‰è¨€å’Œåè¯­ã€‚
"""
            # è°ƒç”¨AIç”Ÿæˆï¼ˆtemperature=0.8ï¼Œæ¯”è¾ƒæœ‰åˆ›æ„ï¼‰
            story = call_ai(prompt, temperature=0.8)
            
            # æ˜¾ç¤ºç»“æœ
            st.success("âœ… æ•…äº‹ç”Ÿæˆå®Œæˆï¼")
            st.markdown("### ä½ çš„ç¡å‰æ•…äº‹")
            st.write(story)
            
            # ä¸‹è½½æŒ‰é’®
            st.download_button(
                label="ğŸ’¾ ä¸‹è½½æ•…äº‹",
                data=story,
                file_name="ç¡å‰æ•…äº‹.txt",
                mime="text/plain"
            )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åŠŸèƒ½2ï¼šå†¥æƒ³å¼•å¯¼è„šæœ¬
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab2:
    st.header("ğŸ§˜ å†¥æƒ³å¼•å¯¼è„šæœ¬")
    st.write("ç”Ÿæˆé€‚åˆä½ å½“å‰çŠ¶æ€çš„å†¥æƒ³å¼•å¯¼è¯")
    
    col1, col2 = st.columns(2)
    
    with col1:
        # æ—¶é•¿é€‰æ‹©
        duration = st.selectbox(
            "å†¥æƒ³æ—¶é•¿",
            ["5åˆ†é’Ÿ", "10åˆ†é’Ÿ", "15åˆ†é’Ÿ", "20åˆ†é’Ÿ"]
        )
        
        # æƒ…ç»ªé€‰æ‹©
        emotion = st.selectbox(
            "å½“å‰æƒ…ç»ª",
            ["ğŸ˜° ç„¦è™‘ç´§å¼ ", "ğŸ˜Š å¹³é™æ”¾æ¾", "ğŸ˜” ç–²æƒ«åŠ³ç´¯", "ğŸ˜¤ çƒ¦èºä¸å®‰", "ğŸ˜ƒ ç²¾åŠ›å……æ²›"]
        )
    
    with col2:
        # å†¥æƒ³ç±»å‹
        meditation_type = st.radio(
            "å†¥æƒ³ç±»å‹",
            ["å‘¼å¸å†¥æƒ³", "èº«ä½“æ‰«æ", "æ­£å¿µå†¥æƒ³", "æ„Ÿæ©å†¥æƒ³"]
        )
    
    # ç”ŸæˆæŒ‰é’®
    if st.button("ğŸ§˜ ç”Ÿæˆå†¥æƒ³è„šæœ¬", key="meditation_btn"):
        with st.spinner("æ­£åœ¨ç”Ÿæˆå†¥æƒ³å¼•å¯¼è¯..."):
            # æ„å»ºæç¤ºè¯
            prompt = f"""
è¯·ç”Ÿæˆä¸€æ®µå†¥æƒ³å¼•å¯¼è„šæœ¬ã€‚

è¦æ±‚ï¼š
- æ—¶é•¿ï¼š{duration}
- å½“å‰æƒ…ç»ªï¼š{emotion}
- å†¥æƒ³ç±»å‹ï¼š{meditation_type}
- è¯­è¨€è¦æ¸©æŸ”ã€ç¼“æ…¢ï¼Œé€‚åˆè·Ÿéšå¼•å¯¼
- åŒ…å«æ¸…æ™°çš„æ­¥éª¤å’Œæ—¶é—´èŠ‚ç‚¹
- å¸®åŠ©ç”¨æˆ·ä»å½“å‰æƒ…ç»ªçŠ¶æ€é€æ¸è¿›å…¥å¹³é™

æ ¼å¼ï¼š
1. å¼€åœºå¼•å¯¼ï¼ˆè®©ç”¨æˆ·æ‰¾åˆ°èˆ’é€‚å§¿åŠ¿ï¼‰
2. ä¸»ä½“å¼•å¯¼ï¼ˆæ ¹æ®å†¥æƒ³ç±»å‹è®¾è®¡å…·ä½“æ­¥éª¤ï¼‰
3. ç»“æŸå¼•å¯¼ï¼ˆæ…¢æ…¢å›åˆ°å½“ä¸‹ï¼‰

è¯·ç›´æ¥è¾“å‡ºå¼•å¯¼è„šæœ¬ï¼Œä¸è¦å‰è¨€å’Œåè¯­ã€‚
"""
            # è°ƒç”¨AIç”Ÿæˆ
            meditation_script = call_ai(prompt, temperature=0.6)
            
            # æ˜¾ç¤ºç»“æœ
            st.success("âœ… å†¥æƒ³è„šæœ¬ç”Ÿæˆå®Œæˆï¼")
            st.markdown("### ä½ çš„å†¥æƒ³å¼•å¯¼")
            st.info("ğŸ’¡ å»ºè®®ï¼šæ‰¾ä¸€ä¸ªå®‰é™çš„åœ°æ–¹ï¼Œè·Ÿéšå¼•å¯¼è¯æ…¢æ…¢ç»ƒä¹ ")
            st.write(meditation_script)
            
            # ä¸‹è½½æŒ‰é’®
            st.download_button(
                label="ğŸ’¾ ä¸‹è½½è„šæœ¬",
                data=meditation_script,
                file_name="å†¥æƒ³å¼•å¯¼è„šæœ¬.txt",
                mime="text/plain"
            )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åŠŸèƒ½3ï¼šç¡çœ æ—¥è®°æ¨¡æ¿
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab3:
    st.header("ğŸ“ ç¡çœ æ—¥è®°æ¨¡æ¿")
    st.write("æ ¹æ®ä½ ä»Šå¤©çš„çŠ¶æ€ï¼Œç”Ÿæˆä¸€ä¸ªä¸ªæ€§åŒ–çš„ç¡çœ æ—¥è®°æ¨¡æ¿")
    
    # ä»Šæ—¥çŠ¶æ€è¾“å…¥
    st.subheader("ğŸ“‹ ä»Šæ—¥çŠ¶æ€è®°å½•")
    
    col1, col2 = st.columns(2)
    
    with col1:
        # æƒ…ç»ªçŠ¶æ€
        mood_today = st.text_input(
            "ä»Šå¤©çš„å¿ƒæƒ…å¦‚ä½•ï¼Ÿ",
            placeholder="ä¾‹å¦‚ï¼šå‹åŠ›å¤§ã€å¼€å¿ƒã€å¹³é™ã€ç–²å€¦..."
        )
        
        # èº«ä½“çŠ¶æ€
        physical_state = st.text_input(
            "èº«ä½“çŠ¶æ€å¦‚ä½•ï¼Ÿ",
            placeholder="ä¾‹å¦‚ï¼šå¾ˆç´¯ã€ç²¾åŠ›å……æ²›ã€æœ‰ç‚¹å¤´ç–¼..."
        )
    
    with col2:
        # ç¡çœ ç›®æ ‡
        sleep_goal = st.text_input(
            "ä»Šæ™šçš„ç¡çœ ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ",
            placeholder="ä¾‹å¦‚ï¼šæ—©ç‚¹ç¡ã€ç¡å¾—æ›´æ·±ã€ä¸åšå™©æ¢¦..."
        )
        
        # ç‰¹æ®Šäº‹ä»¶
        special_event = st.text_area(
            "ä»Šå¤©æœ‰ä»€ä¹ˆç‰¹åˆ«çš„äº‹æƒ…å—ï¼Ÿï¼ˆå¯é€‰ï¼‰",
            placeholder="ä¾‹å¦‚ï¼šä»Šå¤©å®Œæˆäº†ä¸€ä¸ªé‡è¦é¡¹ç›®ã€å’Œæœ‹å‹åµæ¶äº†...",
            height=80
        )
    
    # ç”ŸæˆæŒ‰é’®
    if st.button("ğŸ“ ç”Ÿæˆæ—¥è®°æ¨¡æ¿", key="diary_btn"):
        # æ£€æŸ¥å¿…å¡«é¡¹
        if not mood_today or not physical_state or not sleep_goal:
            st.warning("âš ï¸ è¯·è‡³å°‘å¡«å†™å¿ƒæƒ…ã€èº«ä½“çŠ¶æ€å’Œç¡çœ ç›®æ ‡")
        else:
            with st.spinner("æ­£åœ¨ç”Ÿæˆä¸ªæ€§åŒ–æ—¥è®°æ¨¡æ¿..."):
                # æ„å»ºæç¤ºè¯
                prompt = f"""
è¯·æ ¹æ®ç”¨æˆ·ä»Šå¤©çš„çŠ¶æ€ï¼Œç”Ÿæˆä¸€ä¸ªä¸ªæ€§åŒ–çš„ç¡çœ æ—¥è®°æ¨¡æ¿ã€‚

ç”¨æˆ·ä»Šæ—¥çŠ¶æ€ï¼š
- å¿ƒæƒ…ï¼š{mood_today}
- èº«ä½“ï¼š{physical_state}
- ç¡çœ ç›®æ ‡ï¼š{sleep_goal}
- ç‰¹æ®Šäº‹ä»¶ï¼š{special_event if special_event else "æ— "}

è¦æ±‚ï¼š
1. æ ¹æ®ç”¨æˆ·çŠ¶æ€ï¼Œç»™å‡ºæ¸©æš–çš„å›åº”å’Œå»ºè®®
2. ç”Ÿæˆä¸€ä¸ªç»“æ„åŒ–çš„æ—¥è®°æ¨¡æ¿ï¼ŒåŒ…æ‹¬ï¼š
   - ä»Šæ—¥å›é¡¾ï¼ˆé’ˆå¯¹ç”¨æˆ·æåˆ°çš„çŠ¶æ€ï¼‰
   - ç¡å‰æ„Ÿå—ï¼ˆå¼•å¯¼ç”¨æˆ·è®°å½•ï¼‰
   - æ˜å¤©æœŸå¾…ï¼ˆæ­£å‘å¼•å¯¼ï¼‰
   - ç¡çœ è®¡åˆ’ï¼ˆå…·ä½“çš„åŠ©çœ è¡ŒåŠ¨ï¼‰
3. è¯­æ°”æ¸©æŸ”ã€é¼“åŠ±
4. é€‚åˆç”¨æˆ·å¡«å†™å’Œè®°å½•

è¯·ç›´æ¥è¾“å‡ºæ—¥è®°æ¨¡æ¿ï¼Œä¸è¦å‰è¨€å’Œåè¯­ã€‚
"""
                # è°ƒç”¨AIç”Ÿæˆ
                diary_template = call_ai(prompt, temperature=0.7)
                
                # æ˜¾ç¤ºç»“æœ
                st.success("âœ… æ—¥è®°æ¨¡æ¿ç”Ÿæˆå®Œæˆï¼")
                st.markdown("### ä½ çš„ç¡çœ æ—¥è®°")
                st.write(diary_template)
                
                # ä¸‹è½½æŒ‰é’®
                st.download_button(
                    label="ğŸ’¾ ä¸‹è½½æ—¥è®°æ¨¡æ¿",
                    data=diary_template,
                    file_name="ç¡çœ æ—¥è®°.txt",
                    mime="text/plain"
                )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é¡µé¢åº•éƒ¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
st.markdown("---")
st.markdown(
    """
    <div style='text-align: center; color: gray; font-size: 12px;'>
    ğŸ’¤ ç¡å‰å†…å®¹ç”Ÿæˆå™¨ | åŸºäºé€šä¹‰åƒé—®API + Streamlit<br>
    ç¥ä½ ä»Šæ™šç¡ä¸ªå¥½è§‰ ğŸŒ™
    </div>
    """,
    unsafe_allow_html=True
)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# API Keyæ£€æŸ¥æç¤º
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if API_KEY == 'your-api-key-here':
    st.error("""
    âš ï¸ è¯·å…ˆè®¾ç½®ä½ çš„API Keyï¼
    
    1. æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ sleep_app.py
    2. æ‰¾åˆ°ç¬¬13è¡Œçš„ API_KEY = 'your-api-key-here'
    3. æŠŠ 'your-api-key-here' æ›¿æ¢æˆä½ çš„é€šä¹‰åƒé—®API Key
    4. ä¿å­˜æ–‡ä»¶åé‡æ–°è¿è¡Œ
    """)